<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <record id="automated_action_recurring_invoice_sale_order" model="base.automation">
            <field name="name">Facturación Recurrente de Órdenes de Venta</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="trigger">on_create_or_update</field>
            <field name="active" eval="True"/>
            <field name="filter_domain">[('x_studio_mtodo_de_facturacin', '=', 'Último día del mes'), ('x_studio_recurrente', '=', True)]</field>
            <field name="action_server_id" ref="your_module_id.action_server_for_recurring_invoice"/>
        </record>

        <record id="action_server_for_recurring_invoice" model="ir.actions.server">
            <field name="name">Facturación Recurrente</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="binding_model_id" ref="sale.model_sale_order"/>
            <field name="state">code</field>
            <field name="code">
                for order in records:
                    hoy = datetime.date.today()

                    if order.start_date and order.end_date:
                        if not (order.start_date <= hoy <= order.end_date):
                            continue

                    if not order.x_studio_recurrente:
                        continue

                    metodo = order.x_studio_mtodo_de_facturacin

                    if metodo == 'Día en concreto':
                        if not order.x_studio_fecha:
                            continue

                        fecha_objetivo = order.x_studio_fecha

                        if hoy.day == fecha_objetivo.day and hoy.month == fecha_objetivo.month:
                            if order.state == 'sale' and order.invoice_status != 'invoiced':
                                invoice = order._create_invoices()
                                invoice.action_post()

                    elif metodo == 'Último día del mes':
                        manana = hoy + datetime.timedelta(days=1)
                        if manana.month != hoy.month:
                            if order.state == 'sale' and order.invoice_status != 'invoiced':
                                invoice = order._create_invoices()
                                invoice.action_post()
            </field>
        </record>
    </data>
</odoo>