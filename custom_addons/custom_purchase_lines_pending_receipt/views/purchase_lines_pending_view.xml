<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Vista Lista/Tree para líneas de compra pendientes -->
        <record id="view_purchase_order_line_pending_tree" model="ir.ui.view">
            <field name="name">purchase.order.line.pending.tree</field>
            <field name="model">purchase.order.line</field>
            <field name="type">list</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <list string="Líneas Pendientes de Recibir" decoration-info="qty_received == 0" decoration-warning="qty_received &lt; product_qty">
                    <field name="order_id" string="Pedido de Compra"/>
                    <field name="partner_id" string="Proveedor"/>
                    <field name="product_id" string="Producto"/>
                    <field name="name" string="Descripción"/>
                    <field name="product_qty" string="Cantidad Pedida"/>
                    <field name="qty_received" string="Cantidad Recibida"/>
                    <field name="qty_to_invoice" string="Por Facturar"/>
                    <field name="price_unit" string="Precio Unitario"/>
                    <field name="price_subtotal" string="Subtotal"/>
                    <field name="date_planned" string="Fecha Prevista"/>
                    <field name="state" string="Estado" invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Vista de búsqueda personalizada -->
        <record id="view_purchase_order_line_pending_search" model="ir.ui.view">
            <field name="name">purchase.order.line.pending.search</field>
            <field name="model">purchase.order.line</field>
            <field name="type">search</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <search string="Buscar Líneas Pendientes">
                    <field name="order_id" string="Pedido" filter_domain="[('order_id.name', 'ilike', self)]"/>
                    <field name="product_id" string="Producto"/>
                    <field name="partner_id" string="Proveedor"/>
                    <field name="date_planned" string="Fecha Prevista"/>
                    
                    <separator/>
                    
                    <filter name="not_received" string="Sin Recibir" 
                            domain="[('qty_received', '=', 0)]" 
                            help="Líneas que no han sido recibidas"/>
                    
                    <filter name="partially_received" string="Parcialmente Recibidas" 
                            domain="[('qty_received', '&gt;', 0), ('product_qty', '&gt;', 0)]" 
                            help="Líneas parcialmente recibidas"/>
                    
                    <filter name="pending_receipt" string="Pendientes de Recibir" 
                            domain="[('qty_received', '&gt;=', 0)]" 
                            help="Todas las líneas pendientes"/>
                    
                    <separator/>
                    
                    <filter name="this_week" string="Esta Semana" 
                            domain="[('date_planned', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), 
                                     ('date_planned', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    
                    <filter name="overdue" string="Vencidas" 
                            domain="[('date_planned', '&lt;', context_today().strftime('%Y-%m-%d'))]"/>
                    
                    <separator/>
                    
                    <group expand="0" string="Agrupar Por">
                        <filter name="group_by_order" string="Pedido de Compra" 
                                context="{'group_by': 'order_id'}"/>
                        <filter name="group_by_supplier" string="Proveedor" 
                                context="{'group_by': 'partner_id'}"/>
                        <filter name="group_by_product" string="Producto" 
                                context="{'group_by': 'product_id'}"/>
                        <filter name="group_by_date" string="Fecha Prevista" 
                                context="{'group_by': 'date_planned'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Acción de ventana para mostrar las líneas pendientes -->
        <record id="action_purchase_lines_pending_receipt" model="ir.actions.act_window">
            <field name="name">Líneas Pendientes de Recibir</field>
            <field name="res_model">purchase.order.line</field>
            <field name="view_mode">list</field>
            <field name="view_id" ref="view_purchase_order_line_pending_tree"/>
            <field name="search_view_id" ref="view_purchase_order_line_pending_search"/>
            <field name="domain">[('order_id.state', 'in', ['purchase', 'done']), ('qty_received', '&lt;', 'product_qty')]</field>
            <field name="context">{
                'default_state': 'purchase',
                'search_default_pending_receipt': 1,
                'search_default_group_by_order': 1
            }</field>
            <field name="limit">80</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    ¡No hay líneas pendientes de recibir!
                </p>
                <p>
                    Aquí aparecerán las líneas de pedidos de compra confirmados 
                    que aún están pendientes de ser recibidas completamente.
                </p>
                <p>
                    Las líneas se muestran cuando:
                    <ul>
                        <li>El pedido está en estado "Pedido de Compra" o "Bloqueado"</li>
                        <li>La cantidad recibida es menor que la cantidad pedida</li>
                    </ul>
                </p>
            </field>
        </record>

        <!-- Menú en Compras -->
        <menuitem id="menu_purchase_lines_pending"
                  name="Líneas Pendientes"
                  parent="purchase.menu_purchase_root"
                  action="action_purchase_lines_pending_receipt"
                  sequence="25"
                  groups="purchase.group_purchase_user"/>

    </data>
</odoo>